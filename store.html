<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BD Store - All Features</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background: #0d0d0d; color: white; font-family: sans-serif; margin: 0; padding: 20px; }
    h1 { color: #ff4d4d; }
    .store-container { max-width: 900px; margin: auto; }
    .inventory, .store-items, .admin-panel, .achievement-panel, .stats-panel { margin-top: 30px; padding: 20px; background: #1a1a1a; border-radius: 10px; }
    .item { margin-bottom: 15px; border: 1px solid #333; padding: 10px; border-radius: 6px; }
    .owned { color: #10b981; }
    .equipped { font-weight: bold; color: #00ffff; }
    button { background: #ff4d4d; color: white; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; margin-left: 5px; }
    button[disabled] { background: #555; cursor: not-allowed; }
    input { padding: 5px; margin: 5px; border-radius: 5px; border: 1px solid #444; }
    .section-title { color: #ffcc00; font-size: 1.3em; margin-bottom: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="store-container">
    <h1>BD Clan Store</h1>
    <div id="login-section">
      <input id="code-input" placeholder="Enter your code">
      <button onclick="login()">Login</button>
      <p id="login-status"></p>
    </div>
    <div id="store-content" class="hidden">
      <p>Coins: <span id="coin-display">0</span></p>
      <div class="store-items">
        <div class="section-title">Store Items</div>
        <div id="store-list"></div>
      </div>
      <div class="inventory">
        <div class="section-title">Inventory</div>
        <div id="inventory-list"></div>
      </div>
      <div class="achievement-panel">
        <div class="section-title">Achievements</div>
        <div id="achievement-list"></div>
      </div>
      <div class="admin-panel hidden">
        <div class="section-title">Admin Controls</div>
        <input id="item-name" placeholder="Item Name">
        <input id="item-price" placeholder="Price" type="number">
        <input id="item-description" placeholder="Description">
        <button onclick="addItem()">Add Item</button>
        <div id="admin-items"></div>
      </div>
      <div class="stats-panel hidden">
        <div class="section-title">Store Stats</div>
        <pre id="store-stats"></pre>
      </div>
    </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBDgadn_l0VLJmgCPzziGbwbXYaIfhn0vQ",
      authDomain: "aoh-bd-clan.firebaseapp.com",
      databaseURL: "https://aoh-bd-clan-default-rtdb.firebaseio.com",
      projectId: "aoh-bd-clan"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let userData = {};

    async function login() {
      const code = document.getElementById("code-input").value.trim();
      const snap = await db.ref("minigameKillers").once("value");
      const all = snap.val();
      for (const user in all) {
        if (all[user].code === code) {
          currentUser = user;
          userData = all[user];
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("store-content").classList.remove("hidden");
          if (userData.isAdmin) {
            document.querySelector(".admin-panel").classList.remove("hidden");
            document.querySelector(".stats-panel").classList.remove("hidden");
          }
          loadStore();
          return;
        }
      }
      document.getElementById("login-status").textContent = "Invalid code";
    }

    async function loadStore() {
      const [storeSnap, userSnap] = await Promise.all([
        db.ref("storeItems").once("value"),
        db.ref("minigameKillers/" + currentUser).once("value")
      ]);
      const items = storeSnap.val() || {};
      const user = userSnap.val() || {};
      const inv = user.inventory || {};
      const eq = user.equipped || {};
      const ach = user.achievements || {};
      document.getElementById("coin-display").textContent = user.coins || 0;

      const storeList = document.getElementById("store-list");
      storeList.innerHTML = "";
      for (const key in items) {
        const item = items[key];
        const owned = inv[key];
        const equipped = eq[key];
        const isExpired = item.expiresAt && new Date(item.expiresAt) < new Date();
        const html = `
          <div class="item">
            <b>${item.name}</b> - ${item.description} (${item.price} coins)
            ${isExpired ? '<span style="color:red;">[Expired]</span>' :
              owned ? '<span class="owned">[Owned]</span>' :
              `<button onclick="buyItem('${key}', ${item.price})">Buy</button>`}
            ${owned && !isExpired ? 
              (equipped ? '<span class="equipped">[Equipped]</span>' :
              `<button onclick="equipItem('${key}')">Equip</button>`) : ''}
          </div>
        `;
        storeList.innerHTML += html;
      }

      const inventoryList = document.getElementById("inventory-list");
      inventoryList.innerHTML = Object.keys(inv).length === 0 ? "None" :
        Object.keys(inv).map(k => `‚úî ${k}`).join("<br>");

      const achList = document.getElementById("achievement-list");
      achList.innerHTML = Object.keys(ach).length === 0 ? "No achievements yet." :
        Object.keys(ach).map(k => `üèÜ ${k}`).join("<br>");
    }

    async function buyItem(key, price) {
      const ref = db.ref("minigameKillers/" + currentUser);
      const snap = await ref.once("value");
      const data = snap.val();
      if ((data.coins || 0) < price) return alert("Not enough coins");
      if (data.inventory && data.inventory[key]) return alert("Already owned");

      const updates = {};
      updates["coins"] = (data.coins || 0) - price;
      updates["inventory/" + key] = true;

      await ref.update(updates);
      db.ref("purchaseLogs").push({
        user: currentUser, item: key, price, time: Date.now()
      });
      await db.ref("adminLogs").push({
        username: currentUser, action: `Purchased ${key}`, time: new Date().toISOString()
      });

      if (price >= 500) {
        await ref.child("achievements/store_spender").set(true);
      }

      loadStore();
    }

    async function equipItem(key) {
      const ref = db.ref(`minigameKillers/${currentUser}/equipped`);
      await ref.update({ [key]: true });
      loadStore();
    }

    async function addItem() {
      const name = document.getElementById("item-name").value.trim();
      const price = parseInt(document.getElementById("item-price").value);
      const desc = document.getElementById("item-description").value.trim();
      const key = name.toLowerCase().replace(/\s+/g, "_");

      if (!name || isNaN(price)) return alert("Invalid input");

      await db.ref("storeItems/" + key).set({ name, price, description: desc });
      await db.ref("adminLogs").push({
        username: currentUser, action: `Added/Updated item: ${name}`, time: new Date().toISOString()
      });

      loadStore();
    }
  </script>
</body>
</html>
