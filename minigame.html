<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BD Clan Battle Minigame</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* Particle effect */
    @keyframes particle {
      0% { transform: translate(0, 0); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)); opacity: 0; }
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background-color: #ff4d4d;
      border-radius: 50%;
      pointer-events: none;
      animation: particle 0.6s ease-out forwards;
    }

    /* Screen shake */
    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    .navbar {
      background-color: rgba(26, 26, 46, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 77, 77, 0.2);
    }

    .nav-link {
      position: relative;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }

    .nav-link:hover {
      color: #ff4d4d;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background-color: #ff4d4d;
      transition: width 0.3s ease;
    }

    .nav-link:hover::after {
      width: 100%;
    }

    .mobile-menu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .mobile-menu.open {
      max-height: 500px;
      transition: max-height 0.3s ease-in;
    }
    
    .hidden {
      display: none;
    }

    .fixed {
      position: fixed;
    }
    
    .health-bar {
      height: 20px;
      background-color: #4b5563;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .health-fill {
      height: 100%;
      background-color: #10b981;
      transition: width 0.3s ease;
    }
  </style>
</head>
<!-- Navigation Menu -->
<nav class="navbar fixed top-0 w-full z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <div class="flex-shrink-0">
        <span class="text-xl font-bold demon-text">AOH - BD Clan</span>
      </div>

      <!-- Desktop Menu -->
      <div class="hidden md:block">
        <div class="ml-10 flex items-center space-x-4">
          <a href="index.html" class="nav-link text-white" onclick="showMainMenu()">
            <i class="fas fa-home mr-1"></i> Home
          </a>
          <a href="admin-log.html" class="nav-link text-white" onclick="showMembersDashboard()">
            <i class="fas fa-users mr-1"></i> ADMIN-LOGS
          </a>
          <a href="admin.html" class="nav-link text-white" onclick="showAdminAccess()">
            <i class="fas fa-lock mr-1"></i> Admin
          </a>
          <a href="minigame.html" class="nav-link text-white" onclick="showAdminNote()">
            <i class="fas fa-info-circle mr-1"></i> MiniGame
          </a>
        </div>
      </div>

      <!-- Mobile menu button -->
      <div class="md:hidden">
        <button onclick="toggleMobileMenu()" class="text-white hover:text-red-400 focus:outline-none">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div class="mobile-menu md:hidden bg-gray-900">
    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
      <a href="#" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-800" onclick="showMainMenu(); toggleMobileMenu()">
        <i class="fas fa-home mr-2"></i> Home
      </a>
      <a href="#" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-800" onclick="showMembersDashboard(); toggleMobileMenu()">
        <i class="fas fa-users mr-2"></i> Members
      </a>
      <a href="admin.html" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-800" onclick="showAdminAccess(); toggleMobileMenu()">
        <i class="fas fa-lock mr-2"></i> Admin
      </a>
      <a href="minigame.html" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-800" onclick="showAdminNote(); toggleMobileMenu()">
        <i class="fas fa-info-circle mr-2"></i> Minigame
      </a>
    </div>
  </div>
</nav>

<body class="bg-gray-900 text-white font-sans p-4">
  <h1 class="text-3xl font-bold text-center mb-6">BD Clan Minigame</h1>
  <div class="max-w-4xl mx-auto">
    <button id="admin-btn" class="fixed top-4 right-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg">
      Admin Mode
    </button>
    
    <div class="mb-4">
      <label for="killer-select" class="block mb-2">Select Killer:</label>
      <select id="killer-select" class="text-black p-2 rounded w-full"></select>
      <button onclick="verifyCode()" class="mt-2 p-2 bg-blue-600 hover:bg-blue-700 rounded w-full">Verify Code</button>
    </div>
    
    <div id="code-input-area" class="mb-4 hidden">
      <input id="code-input" type="text" placeholder="Enter Code" class="text-black p-2 rounded w-full" maxlength="5"/>
      <button onclick="confirmKiller()" class="mt-2 p-2 bg-green-600 hover:bg-green-700 rounded w-full">Confirm</button>
      <p id="code-error" class="text-red-500 mt-2 hidden"></p>
    </div>
    
    <div id="game-area" class="hidden">
      <h2 class="text-xl font-bold mb-2">Targets</h2>
      <div id="targets" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      
      <div class="mt-6 bg-gray-800 p-4 rounded">
        <h3 class="text-xl font-bold mb-2">Stats</h3>
        <p class="text-lg">üí∞ Coins: <span id="coin-count">0</span></p>
        <p>üî™ Total Kills: <span id="total-kills">0</span></p>
        <div id="killer-stats" class="mt-2"></div>
        
        <div class="mt-4">
          <button onclick="grantDailyReward()" class="bg-yellow-400 hover:bg-yellow-500 text-black px-4 py-2 rounded w-full">
            üéÅ Claim Daily Reward (5 Coins)
          </button>
        </div>
        
        <div class="mt-4">
          <div class="flex items-center">
            <input type="number" id="story-coin-input" placeholder="Coins to exchange" 
                   class="text-black p-2 rounded w-full" min="1" />
            <button onclick="exchangeCoinsForLevels()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded ml-2 whitespace-nowrap">
              üìò Exchange
            </button>
          </div>
          <p id="story-result" class="text-green-400 mt-2"></p>
        </div>
        
        <!-- Achievements Section -->
        <div id="achievements" class="mt-6 space-y-2"></div>
        
        <!-- Leaderboard Section -->
        <div class="mt-6">
          <h3 class="text-xl font-bold mb-2">Leaderboard</h3>
          <div id="leaderboard" class="space-y-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tutorial Overlay -->
  <div id="tutorial-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4">
      <h2 class="text-2xl font-bold mb-4">Welcome to BD Clan Minigame!</h2>
      <div id="tutorial-content" class="space-y-4">
        <!-- Content will be filled by JS -->
      </div>
      <button id="tutorial-next" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded">
        Next
      </button>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="admin-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-8 rounded-lg max-w-md w-full">
      <h2 class="text-2xl font-bold mb-4 text-red-500">Admin Login</h2>
      <input type="password" id="admin-key-input" placeholder="Enter Admin Key" 
            class="w-full p-3 mb-4 rounded bg-gray-700 text-white">
      <button onclick="verifyAdminKey()" 
              class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">
        Login
      </button>
      <p id="admin-error" class="text-red-500 mt-2 hidden"></p>
    </div>
  </div>

  <!-- Shop Manager -->
  <div id="admin-shop" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-4">Shop Manager</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-bold mb-2">Add Item</h3>
          <input id="shop-item-name" placeholder="Item name" class="w-full p-2 mb-2 rounded bg-gray-700">
          <input id="shop-item-price" type="number" placeholder="Price in coins" class="w-full p-2 mb-2 rounded bg-gray-700">
          <button onclick="addShopItem()" class="w-full bg-green-600 hover:bg-green-700 p-2 rounded">Add</button>
        </div>
        <div>
          <h3 class="font-bold mb-2">Current Items</h3>
          <div id="shop-items-list" class="space-y-2"></div>
        </div>
      </div>
      <button onclick="closeShopManager()" class="mt-4 w-full bg-red-600 hover:bg-red-700 p-2 rounded">Close</button>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBDgadn_l0VLJmgCPzziGbwbXYaIfhn0vQ",
      authDomain: "aoh-bd-clan.firebaseapp.com",
      databaseURL: "https://aoh-bd-clan-default-rtdb.firebaseio.com",
      projectId: "aoh-bd-clan",
      storageBucket: "aoh-bd-clan.firebasestorage.app",
      messagingSenderId: "824398865971",
      appId: "1:824398865971:web:139890878f47e251ad6546",
      measurementId: "G-4V15NCH2RH"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let gameState = {
      killer: null,
      killerData: {},
      targets: {},
      stats: { totalKills: 0, killDetails: {} },
      killers: {},
      shopItems: {}
    };

    // ADMIN STATE MANAGEMENT
    let isAdmin = false;
    const adminGiftCooldowns = {};

    // Tutorial Steps
    const TUTORIAL_STEPS = [
      {
        title: "Welcome!",
        content: "This minigame lets you attack targets to earn kills and coins.",
        icon: "üëã"
      },
      {
        title: "Select Your Killer",
        content: "Choose your username from the dropdown to get started.",
        icon: "üî™"
      },
      {
        title: "Verify Your Code",
        content: "You'll receive a unique code. Enter it to confirm your identity.",
        icon: "üîí"
      },
      {
        title: "Attack Targets",
        content: "Click attack buttons to damage targets. Reduce their health to 0 to get a kill!",
        icon: "‚öîÔ∏è"
      },
      {
        title: "Earn Rewards",
        content: "Get coins for kills and daily rewards. Exchange coins for story levels!",
        icon: "üí∞"
      },
      {
        title: "Leaderboards",
        content: "Compete with other players on the leaderboard!",
        icon: "üèÜ"
      }
    ];

    // Achievements
    const ACHIEVEMENTS = {
      first_kill: {
        title: "First Blood",
        description: "Get your first kill",
        icon: "ü©∏",
        check: (killer) => killer.totalKills >= 1
      },
      veteran: {
        title: "Veteran",
        description: "Reach 100 total kills",
        icon: "ü™ñ",
        check: (killer) => killer.totalKills >= 100
      },
      assassin: {
        title: "Assassin",
        description: "Kill each target at least once",
        icon: "üó°Ô∏è",
        check: (killer) => gameState.targets && 
          Object.keys(gameState.targets).every(t => killer.kills?.[t] > 0)
      },
      rich: {
        title: "Rich",
        description: "Collect 50 coins",
        icon: "üí∞",
        check: (killer) => killer.coins >= 50
      }
    };

    // Initialize when page loads
    document.addEventListener("DOMContentLoaded", () => {
      loadMembers();
      initAdminFeatures();
      
      // Show tutorial if not completed
      if (!localStorage.getItem("tutorialCompleted")) {
        setTimeout(showTutorial, 1000);
      }
    });

    // Load clan members for killer selection
    function loadMembers() {
      document.getElementById("killer-select").disabled = true;
      db.ref("clanData/members").once("value")
        .then(snap => {
          const members = snap.val() || [];
          const select = document.getElementById("killer-select");
          select.innerHTML = '';
          
          members.forEach(member => {
            const opt = document.createElement("option");
            opt.value = member.username;
            opt.textContent = member.username;
            select.appendChild(opt);
          });
          
          initializeGameData();
        })
        .catch(error => {
          console.error("Error loading members:", error);
          alert("Failed to load members. Check console for details.");
        })
        .finally(() => {
          document.getElementById("killer-select").disabled = false;
        });
    }

    // Initialize game data structures if they don't exist
    function initializeGameData() {
      const initData = {
        minigameTargets: {
          "Ban": { health: 100, maxHealth: 100 },
          "Kyle": { health: 100, maxHealth: 100 },
          "Levi": { health: 100, maxHealth: 100 },
          "Zen": { health: 100, maxHealth: 100 }
        },
        minigameStats: {
          totalKills: 0,
          killDetails: {}
        }
      };

      db.ref("minigameTargets").once('value').then(snap => {
        if (!snap.exists()) {
          return db.ref("minigameTargets").set(initData.minigameTargets)
            .then(() => {
              console.log("Initial targets created");
              gameState.targets = initData.minigameTargets;
              renderTargets();
            });
        }
        return Promise.resolve();
      }).catch(error => {
        console.error("Error initializing targets:", error);
      });

      // Check and initialize each node
      Promise.all([
        checkAndInitNode('minigameTargets', initData.minigameTargets),
        checkAndInitNode('minigameStats', initData.minigameStats)
      ]).then(() => {
        console.log("Game data initialized");
      });
    }

    function checkAndInitNode(path, defaultData) {
      return db.ref(path).once('value').then(snap => {
        if (!snap.exists()) {
          return db.ref(path).set(defaultData);
        }
      });
    }

    // Verify code button handler
    function verifyCode() {
      const name = document.getElementById("killer-select").value;
      if (!name) return alert("Select a killer first.");
      
      gameState.killer = name;
      document.getElementById("code-input-area").classList.remove("hidden");
      document.getElementById("code-input").focus();
    }

    // Toggle mobile menu
    function toggleMobileMenu() {
      document.querySelector('.mobile-menu').classList.toggle('open');
    }

    // Confirm killer with code
    function confirmKiller() {
      const code = document.getElementById("code-input").value.trim();
      const errorElement = document.getElementById("code-error");
      
      if (!code) {
        errorElement.textContent = "Enter your code";
        errorElement.classList.remove("hidden");
        return;
      }

      db.ref('minigameKillers/' + gameState.killer).once('value').then(snap => {
        const killer = snap.val();
        
        if (!killer) {
          // New player - generate code and initialize
          const newKiller = {
            code: generateMemberCode(gameState.killer),
            coins: 0,
            kills: {},
            lastDailyReward: null
          };
          
          return db.ref('minigameKillers/' + gameState.killer).set(newKiller)
            .then(() => {
              gameState.killerData = newKiller;
              showGameArea();
            });
        }
        
        if (killer.code === code) {
          gameState.killerData = killer;
          showGameArea();
        } else {
          errorElement.textContent = "Wrong code!";
          errorElement.classList.remove("hidden");
        }
      }).catch(error => {
        console.error("Error verifying killer:", error);
        errorElement.textContent = "Error verifying code";
        errorElement.classList.remove("hidden");
      });
    }

    // Generate a 5-digit member code
    function generateMemberCode(username) {
      let hash = 0;
      for (let i = 0; i < username.length; i++) {
        hash = (hash << 5) - hash + username.charCodeAt(i);
      }
      return (10000 + (Math.abs(hash) % 90000)).toString();
    }

    // Show the game area after successful verification
    function showGameArea() {
      document.getElementById("code-input-area").classList.add("hidden");
      document.getElementById("game-area").classList.remove("hidden");
      document.getElementById("coin-count").textContent = gameState.killerData.coins || 0;
      loadGameData();
    }

    // Load targets and stats
    function loadGameData() {
      // Load killers data
      db.ref("minigameKillers").once("value").then(snap => {
        gameState.killers = snap.val() || {};
        if (isAdmin) showAdminControls();
      });
      
      // Load targets data
      db.ref("minigameTargets").on("value", snap => {
        gameState.targets = snap.val() || {};
        renderTargets(); 
      });
      
      // Load stats data
      db.ref("minigameStats").on("value", snap => {
        gameState.stats = snap.val() || { totalKills: 0, killDetails: {} };
        document.getElementById("total-kills").textContent = gameState.stats.totalKills;
        renderKillerStats();
      });
      
      // Update leaderboard
      updateLeaderboard();
      
      // Check achievements
      checkAchievements();
    }

    // Render targets with health bars
    function renderTargets() {
      console.log("Attempting to render targets...");
      console.log("Current targets:", gameState.targets);
      
      const container = document.getElementById("targets");
      if (!container) {
        console.error("Targets container not found!");
        return;
      }
      
      container.innerHTML = "";
      
      if (!gameState.targets || Object.keys(gameState.targets).length === 0) {
        container.innerHTML = "<p class='text-red-500'>No targets available!</p>";
        return;
      }
      
      for (const name in gameState.targets) {
        const target = gameState.targets[name];
        const healthPercent = (target.health / target.maxHealth) * 100;
        
        const div = document.createElement("div");
        div.className = "p-4 bg-gray-800 rounded-lg";
        div.innerHTML = `
          <h3 class="text-lg font-bold">${name}</h3>
          <p>Health: <span>${target.health}</span>/${target.maxHealth}</p>
          <div class="health-bar">
            <div class="health-fill" style="width: ${healthPercent}%"></div>
          </div>
          <button onclick="attack('${name}')" 
                  class="mt-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded w-full">
            Attack (-10 HP)
          </button>`;
        container.appendChild(div);
      }
      
      console.log("Targets rendered successfully");
    }

    // Render killer-specific stats
    function renderKillerStats() {
      const container = document.getElementById("killer-stats");
      if (!gameState.killerData.kills) {
        container.innerHTML = "<p>No kills yet!</p>";
        return;
      }
      
      let html = "<p class='font-semibold'>Your Kills:</p><ul class='list-disc pl-5 mt-1'>";
      for (const target in gameState.killerData.kills) {
        const count = gameState.killerData.kills[target];
        html += `<li>${target}: ${count} kill${count !== 1 ? 's' : ''}</li>`;
      }
      html += "</ul>";
      container.innerHTML = html;
    }

    // Update leaderboard
    function updateLeaderboard() {
      db.ref("minigameKillers").once("value").then(snap => {
        const killers = snap.val() || {};
        const leaderboardData = [];
        
        for (const [name, data] of Object.entries(killers)) {
          const totalKills = data.kills ? Object.values(data.kills).reduce((a,b) => a + b, 0) : 0;
          leaderboardData.push({ name, kills: totalKills, coins: data.coins || 0 });
        }
        
        // Sort by kills (descending)
        leaderboardData.sort((a, b) => b.kills - a.kills);
        
        const container = document.getElementById("leaderboard");
        container.innerHTML = '';
        
        leaderboardData.slice(0, 10).forEach((killer, index) => {
          const entry = document.createElement("div");
          entry.className = "flex justify-between items-center p-2 bg-gray-700 rounded";
          entry.innerHTML = `
            <div class="flex items-center">
              <span class="w-6 text-center font-bold">${index + 1}.</span>
              <span class="mx-2">${killer.name}</span>
            </div>
            <span class="text-yellow-400">${killer.kills} kills</span>
          `;
          container.appendChild(entry);
        });
        
        // Add current player highlight if not in top 10
        if (gameState.killer && !leaderboardData.slice(0, 10).some(k => k.name === gameState.killer)) {
          const currentPlayer = leaderboardData.find(k => k.name === gameState.killer);
          if (currentPlayer) {
            const entry = document.createElement("div");
            entry.className = "flex justify-between items-center p-2 bg-blue-900 rounded mt-2";
            entry.innerHTML = `
              <div class="flex items-center">
                <span class="w-6 text-center font-bold">${leaderboardData.findIndex(k => k.name === gameState.killer) + 1}.</span>
                <span class="mx-2">${currentPlayer.name} (You)</span>
              </div>
              <span class="text-yellow-400">${currentPlayer.kills} kills</span>
            `;
            container.appendChild(entry);
          }
        }
      });
    }

    // Attack a target
    function attack(targetName) {
      if (!gameState.killer) {
        alert("Please select and verify your killer first!");
        return;
      }

      // Screen shake effect
      document.body.classList.add('shake');
      setTimeout(() => {
        document.body.classList.remove('shake');
      }, 500);

      // Particle effect
      createParticles(targetName);

      const target = gameState.targets[targetName];
      if (!target) return;

      // Reduce health
      target.health -= 10;

      // Find the target's DOM element
      const targetElements = document.querySelectorAll('#targets > div');
      let targetElement;
      
      // Find the specific target div by checking its h3 content
      targetElements.forEach(div => {
        if (div.querySelector('h3').textContent === targetName) {
          targetElement = div;
        }
      });

      if (targetElement) {
        // Update health text
        const healthText = targetElement.querySelector('p > span');
        if (healthText) healthText.textContent = target.health;
        
        // Update health bar
        const healthBar = targetElement.querySelector('.health-fill');
        if (healthBar) {
          healthBar.style.width = `${(target.health / target.maxHealth) * 100}%`;
        }
      }

      // Check for kill
      if (target.health <= 0) {
        target.health = target.maxHealth;
        recordKill(targetName);
      }

      // Update Firebase
      db.ref("minigameTargets").update({
        [targetName]: { health: target.health, maxHealth: target.maxHealth }
      });
    }

    // Create particle effects
    function createParticles(targetName) {
      const targetElement = document.querySelector(`#targets div:has(h3:contains("${targetName}"))`);
      if (!targetElement) return;

      for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // Random direction and distance
        const angle = Math.random() * Math.PI * 2;
        const distance = 20 + Math.random() * 30;
        particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
        particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
        
        // Random position around the attack button
        const button = targetElement.querySelector('button');
        const rect = button.getBoundingClientRect();
        particle.style.left = `${rect.left + rect.width/2 + (Math.random() * 20 - 10)}px`;
        particle.style.top = `${rect.top + rect.height/2 + (Math.random() * 20 - 10)}px`;
        
        document.body.appendChild(particle);
        
        // Remove particle after animation
        setTimeout(() => {
          particle.remove();
        }, 600);
      }
    }

    // Record a kill
    function recordKill(targetName) {
      gameState.stats.totalKills++;
      gameState.stats.killDetails = gameState.stats.killDetails || {};
      
      // Update killer stats
      gameState.killerData.kills = gameState.killerData.kills || {};
      gameState.killerData.kills[targetName] = (gameState.killerData.kills[targetName] || 0) + 1;
      
      // Update global kill details
      const killKey = `${gameState.killer}-${targetName}`;
      gameState.stats.killDetails[killKey] = (gameState.stats.killDetails[killKey] || 0) + 1;
      
      // Check for coin reward (every 1000 kills)
      if (gameState.killerData.kills[targetName] % 1000 === 0) {
        gameState.killerData.coins = (gameState.killerData.coins || 0) + 1;
        showCoinNotification(targetName);
      }
      
      // Save all updates
      Promise.all([
        db.ref("minigameStats").set(gameState.stats),
        db.ref("minigameKillers/" + gameState.killer).set(gameState.killerData)
      ]).then(() => {
        document.getElementById("coin-count").textContent = gameState.killerData.coins;
        document.getElementById("total-kills").textContent = gameState.stats.totalKills;
        renderKillerStats();
        checkAchievements();
        updateLeaderboard();
      });
    }

    // Show coin notification
    function showCoinNotification(targetName) {
      const notification = document.createElement("div");
      notification.className = "fixed top-4 right-4 bg-yellow-600 text-white px-4 py-2 rounded-lg shadow-lg animate-bounce";
      notification.innerHTML = `
        üéâ +1 Coin for 1000 ${targetName} kills!
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Grant daily reward
    function grantDailyReward() {
      if (!gameState.killer) return alert("Verify first.");
      
      const today = new Date().toISOString().split('T')[0];
      if (gameState.killerData.lastDailyReward === today) {
        alert("You already claimed your daily reward today.");
        return;
      }
      
      gameState.killerData.lastDailyReward = today;
      gameState.killerData.coins = (gameState.killerData.coins || 0) + 5;
      
      db.ref("minigameKillers/" + gameState.killer).set(gameState.killerData)
        .then(() => {
          document.getElementById("coin-count").textContent = gameState.killerData.coins;
          alert("üéâ Daily reward claimed! +5 Coins");
        })
        .catch(error => {
          console.error("Error granting daily reward:", error);
          alert("Failed to claim reward. Try again.");
        });
    }

    // Exchange coins for levels
    function exchangeCoinsForLevels() {
      if (!gameState.killer) return alert("Verify first.");
      
      const input = document.getElementById("story-coin-input");
      const coins = parseInt(input.value);
      const result = document.getElementById("story-result");
      
      if (isNaN(coins) || coins < 1) {
        result.textContent = "Enter a valid number of coins";
        return;
      }
      
      if (coins > gameState.killerData.coins) {
        result.textContent = "Not enough coins!";
        return;
      }
      
      gameState.killerData.coins -= coins;
      const levelsGained = coins * 10; // 10 levels per coin
      
      db.ref("minigameKillers/" + gameState.killer).set(gameState.killerData)
        .then(() => {
          document.getElementById("coin-count").textContent = gameState.killerData.coins;
          result.textContent = `üìö Gained ${levelsGained} story levels!`;
          input.value = "";
        })
        .catch(error => {
          console.error("Error exchanging coins:", error);
          result.textContent = "Error processing exchange";
        });
    }

    // Show tutorial
    function showTutorial() {
      const overlay = document.getElementById("tutorial-overlay");
      const content = document.getElementById("tutorial-content");
      const nextBtn = document.getElementById("tutorial-next");
      
      let currentStep = 0;
      
      function showStep(step) {
        content.innerHTML = `
          <div class="text-center">
            <span class="text-4xl mb-2 inline-block">${TUTORIAL_STEPS[step].icon}</span>
            <h3 class="text-xl font-bold">${TUTORIAL_STEPS[step].title}</h3>
            <p>${TUTORIAL_STEPS[step].content}</p>
          </div>
          <div class="text-center text-sm text-gray-400">
            Step ${step + 1} of ${TUTORIAL_STEPS.length}
          </div>
        `;
        
        nextBtn.textContent = step === TUTORIAL_STEPS.length - 1 ? "Finish" : "Next";
      }
      
      nextBtn.addEventListener("click", () => {
        currentStep++;
        if (currentStep >= TUTORIAL_STEPS.length) {
          // Mark tutorial as completed
          localStorage.setItem("tutorialCompleted", "true");
          overlay.classList.add("hidden");
          return;
        }
        showStep(currentStep);
      });
      
      showStep(0);
      overlay.classList.remove("hidden");
    }

    // Check achievements
    function checkAchievements() {
      if (!gameState.killer || !gameState.killerData) return;
      
      const container = document.getElementById("achievements");
      container.innerHTML = '';
      
      const killerStats = {
        ...gameState.killerData,
        totalKills: gameState.killerData.kills ? 
          Object.values(gameState.killerData.kills).reduce((a, b) => a + b, 0) : 0
      };
      
      for (const [id, achievement] of Object.entries(ACHIEVEMENTS)) {
        const achieved = gameState.killerData.achievements?.includes(id) || 
                        achievement.check(killerStats);
        
        const achievementEl = document.createElement("div");
        achievementEl.className = `p-3 rounded flex items-start ${achieved ? 'bg-green-900' : 'bg-gray-700 opacity-50'}`;
        achievementEl.innerHTML = `
          <span class="text-2xl mr-3">${achievement.icon}</span>
          <div>
            <h4 class="font-bold">${achievement.title}</h4>
            <p class="text-sm">${achievement.description}</p>
            ${achieved ? '<p class="text-xs text-green-300 mt-1">Unlocked!</p>' : ''}
          </div>
        `;
        container.appendChild(achievementEl);
        
        // Award achievement if not already awarded
        if (achievement.check(killerStats) && 
            !gameState.killerData.achievements?.includes(id)) {
          awardAchievement(id);
        }
      }
    }

    // Award achievement
    function awardAchievement(id) {
      const achievement = ACHIEVEMENTS[id];
      if (!achievement) return;
      
      // Show notification
      const notification = document.createElement("div");
      notification.className = "fixed bottom-4 right-4 bg-green-800 text-white px-4 py-2 rounded-lg shadow-lg animate-bounce";
      notification.innerHTML = `
        <span class="text-2xl mr-2">${achievement.icon}</span>
        <div>
          <h4 class="font-bold">Achievement Unlocked!</h4>
          <p>${achievement.title}: ${achievement.description}</p>
        </div>
      `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
      
      // Save to database
      const achievements = [...(gameState.killerData.achievements || []), id];
      db.ref(`minigameKillers/${gameState.killer}/achievements`).set(achievements)
        .then(() => {
          gameState.killerData.achievements = achievements;
        });
    }

    // ADMIN FUNCTIONS
    function initAdminFeatures() {
      // Add admin button event listeners
      document.getElementById('admin-btn').addEventListener('click', () => {
        if (isAdmin) {
          showAdminPanel();
        } else {
          document.getElementById('admin-modal').classList.remove('hidden');
        }
      });
      
      // Load shop items
      loadShopItems();
    }

    // Verify admin key
    function verifyAdminKey() {
      const inputKey = document.getElementById('admin-key-input').value.trim();
      const errorElement = document.getElementById('admin-error');
      
      db.ref('adminKey').once('value').then(snap => {
        if (snap.exists() && snap.val() === inputKey) {
          isAdmin = true;
          document.getElementById('admin-modal').classList.add('hidden');
          
          // Get the killer/username that's currently logged in
          const username = gameState.killer || "Unknown Admin";
          
          // Log this admin login
          logAdminAction(username, "Logged into admin panel");
          
          showAdminControls();
        } else {
          errorElement.textContent = "Invalid admin key";
          errorElement.classList.remove('hidden');
        }
      }).catch(error => {
        errorElement.textContent = "Error verifying key";
        errorElement.classList.remove('hidden');
        console.error("Admin login error:", error);
      });
    }

    // Log admin action
    function logAdminAction(adminName, action) {
      const logEntry = {
        username: adminName,
        action: action,
        time: new Date().toISOString()
      };
      
      db.ref("adminLogs").push(logEntry)
        .catch(error => console.error("Error logging admin action:", error));
    }

    // Show admin controls
    function showAdminControls() {
      if (!isAdmin) return;
      
      // Remove existing admin panel if it exists
      const existingPanel = document.getElementById('admin-panel');
      if (existingPanel) existingPanel.remove();
      
      // Create and show admin panel
      showAdminPanel();
    }

    // Show admin panel
    function showAdminPanel() {
      const panel = document.createElement('div');
      panel.id = 'admin-panel';
      panel.className = 'fixed top-16 right-4 bg-gray-800 p-4 rounded-lg shadow-xl z-40 w-80';
      panel.innerHTML = `
        <h3 class="text-xl font-bold mb-4 border-b pb-2">Admin Controls</h3>
        
        <!-- Victim Management -->
        <div class="mb-4">
          <h4 class="font-bold mb-2">Victim Management</h4>
          <div class="flex mb-2">
            <input id="new-victim" placeholder="New victim" class="flex-1 p-2 rounded-l bg-gray-700">
            <button onclick="addVictim()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-r">Add</button>
          </div>
          <div class="flex">
            <select id="remove-victim" class="flex-1 p-2 rounded-l bg-gray-700">
              ${Object.keys(gameState.targets).map(t => `<option value="${t}">${t}</option>`).join('')}
            </select>
            <button onclick="removeVictim()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-r">Remove</button>
          </div>
        </div>
        
        <!-- Player Management -->
        <div class="mb-4">
          <h4 class="font-bold mb-2">Player Actions</h4>
          <select id="player-select" class="w-full p-2 mb-2 rounded bg-gray-700">
            ${Object.keys(gameState.killers).map(k => `<option value="${k}">${k}</option>`).join('')}
          </select>
          
          <!-- Timeout Buttons -->
          <div class="grid grid-cols-3 gap-2 mb-2">
            ${[1,2,3,4,5,60,300,1440,10080,525600].map(mins => `
              <button onclick="timeoutPlayer(${mins})" class="p-2 rounded ${
                mins > 300 ? 'bg-red-600 hover:bg-red-700' : 
                mins > 60 ? 'bg-orange-600 hover:bg-orange-700' : 'bg-yellow-600 hover:bg-yellow-700'
              }">
                ${formatDuration(mins)}
              </button>
            `).join('')}
          </div>
          
          <!-- Custom Timeout -->
          <div class="flex mb-2">
            <input id="custom-timeout" type="number" placeholder="Minutes" class="flex-1 p-2 rounded-l bg-gray-700">
            <button onclick="customTimeout()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-r">Set</button>
          </div>
          
          <!-- Gift/Ban -->
          <div class="flex space-x-2">
            <button onclick="giftCoins(50)" id="gift-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 p-2 rounded">
              Gift 50 Coins
            </button>
            <button onclick="banPlayer()" class="flex-1 bg-red-600 hover:bg-red-700 p-2 rounded">
              Ban Player
            </button>
          </div>
        </div>
        
        <!-- Shop Management -->
        <div>
          <button onclick="openShopManager()" class="w-full bg-indigo-600 hover:bg-indigo-700 p-2 rounded">
            Manage Shop
          </button>
        </div>
      `;
      document.body.appendChild(panel);
    }

    // VICTIM MANAGEMENT
    function addVictim() {
      if (!isAdmin) return;
      const name = document.getElementById('new-victim').value.trim();
      if (!name) return alert("Enter a name");
      
      db.ref(`minigameTargets/${name}`).set({
        health: 100,
        maxHealth: 100
      }).then(() => {
        logAdminAction(gameState.killer, `Added new victim: ${name}`);
        alert(`${name} added as target!`);
      });
    }

    function removeVictim() {
      if (!isAdmin) return;
      const name = document.getElementById('remove-victim').value;
      if (!name || !gameState.targets[name]) return;
      
      if (confirm(`Remove ${name} as target?`)) {
        db.ref(`minigameTargets/${name}`).remove()
          .then(() => alert(`${name} removed!`));
      }
    }

    // PLAYER MANAGEMENT
    function timeoutPlayer(minutes) {
      if (!isAdmin) return;
      const player = document.getElementById('player-select').value;
      const timeoutEnd = Date.now() + (minutes * 60000);
      
      db.ref(`minigameKillers/${player}/timeout`).set(timeoutEnd)
        .then(() => alert(`${player} timed out for ${formatDuration(minutes)}`));
    }

    function customTimeout() {
      const mins = parseInt(document.getElementById('custom-timeout').value);
      if (isNaN(mins)) return alert("Enter valid minutes");
      timeoutPlayer(mins);
    }

    function banPlayer() {
      if (!isAdmin) return;
      const player = document.getElementById('player-select').value;
      
      if (confirm(`Ban ${player}? They'll lose access for 30 days.`)) {
        logAdminAction(gameState.killer, `Banned player: ${player}`);
        // Backup data first
        db.ref(`minigameKillers/${player}`).once('value').then(snap => {
          const data = snap.val();
          data.bannedAt = Date.now();
          
          db.ref(`bannedPlayers/${player}`).set(data)
            .then(() => {
              db.ref(`minigameKillers/${player}`).remove()
                .then(() => alert(`${player} banned!`));
            });
        });
      }
    }

    function giftCoins(amount) {
      if (!isAdmin) return;
      const player = document.getElementById('player-select').value;
      
      // Check cooldown
      if (adminGiftCooldowns[player] && Date.now() - adminGiftCooldowns[player] < 86400000) {
        const remaining = Math.ceil((86400000 - (Date.now() - adminGiftCooldowns[player])) / 3600000);
        return alert(`Wait ${remaining} hours before gifting ${player} again`);
      }
      
      db.ref(`minigameKillers/${player}/coins`).transaction(coins => (coins || 0) + amount)
        .then(() => {
          adminGiftCooldowns[player] = Date.now();
          alert(`Gifted ${amount} coins to ${player}!`);
          document.getElementById('gift-btn').disabled = true;
          setTimeout(() => {
            document.getElementById('gift-btn').disabled = false;
          }, 86400000);
        });
    }

    // SHOP MANAGEMENT
    function openShopManager() {
      document.getElementById('admin-shop').classList.remove('hidden');
    }

    function closeShopManager() {
      document.getElementById('admin-shop').classList.add('hidden');
    }

    function loadShopItems() {
      db.ref('shopItems').on('value', snap => {
        const items = snap.val() || {};
        const list = document.getElementById('shop-items-list');
        list.innerHTML = Object.entries(items).map(([name, price]) => `
          <div class="flex items-center justify-between p-2 bg-gray-700 rounded">
            <span>${name} (${price} coins)</span>
            <div>
              <button onclick="editShopItem('${name}')" class="p-1 bg-blue-600 hover:bg-blue-700 rounded mr-1">Edit</button>
              <button onclick="removeShopItem('${name}')" class="p-1 bg-red-600 hover:bg-red-700 rounded">Delete</button>
            </div>
          </div>
        `).join('');
      });
    }

    function addShopItem() {
      const name = document.getElementById('shop-item-name').value.trim();
      const price = parseInt(document.getElementById('shop-item-price').value);
      
      if (!name || isNaN(price)) return alert("Enter valid name and price");
      
      db.ref(`shopItems/${name}`).set(price)
        .then(() => {
          document.getElementById('shop-item-name').value = '';
          document.getElementById('shop-item-price').value = '';
        });
    }

    function editShopItem(name) {
      const newPrice = prompt(`New price for ${name}:`, gameState.shopItems[name]);
      if (newPrice && !isNaN(newPrice)) {
        db.ref(`shopItems/${name}`).set(parseInt(newPrice));
      }
    }

    function removeShopItem(name) {
      if (confirm(`Delete ${name} from shop?`)) {
        db.ref(`shopItems/${name}`).remove();
      }
    }

    // HELPER FUNCTIONS
    function formatDuration(minutes) {
      if (minutes < 60) return `${minutes}m`;
      if (minutes < 1440) return `${Math.floor(minutes/60)}h`;
      if (minutes < 10080) return `${Math.floor(minutes/1440)}d`;
      if (minutes < 525600) return `${Math.floor(minutes/10080)}w`;
      return `${Math.floor(minutes/525600)}y`;
    }

    function startAdminSession() {
      // Check for expired bans daily
      setInterval(() => {
        db.ref('bannedPlayers').once('value').then(snap => {
          const now = Date.now();
          snap.forEach(player => {
            if (now - player.val().bannedAt > 2592000000) { // 30 days
              db.ref(`bannedPlayers/${player.key}`).remove();
            }
          });
        });
      }, 86400000); // 24 hours
    }
  </script>
</body>
</html>
